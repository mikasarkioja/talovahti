generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- DOMAIN ---

model HousingCompany {
  id              String      @id @default(cuid())
  businessId      String      @unique
  name            String
  address         String
  city            String
  postalCode      String
  constructionYear Int?
  apartments      Apartment[]
  users           User[]
  surveys         Survey[]
  tickets         Ticket[]
  initiatives     Initiative[]
  documents       MeetingDocument[]
  meetings        Meeting[]
  budgetLines     BudgetLineItem[]
  renovations     Renovation[]
  observations    Observation[]
  investments     InvestmentOption[]
  projects        Project[]
  mmlSyncLogs     MMLSyncLog[]
  documentOrders  DocumentOrder[]
  invoices        Invoice[]
  vendorRules     VendorRule[]
  utilityPrices   UtilityPrice[]
  partners        ServicePartner[]
  residentTasks   ResidentTask[]
  resources       Resource[]
  thermalLeaks    ThermalLeak[]
  
  // LOAN BROKERAGE
  financialStatements FinancialStatement[]
  shareholders        Shareholder[]
  loanApplications    LoanApplication[]
  scenarios           FinancialScenario[]
  investmentGrades    InvestmentGrade[]
  auditLogs           GDPRLog[]

  // FINANCIAL SETTINGS
  iban                String?
  bic                 String?
  accountingApiKey    String?
  maintenanceFeePerShare Decimal @default(4.50)
  financeFeePerShare     Decimal @default(0.00)
  monthlyFees            MonthlyFee[]
  
  // TEMPORAL ENGINE
  fiscalConfig           FiscalConfiguration?
  annualTasks            AnnualTask[]
  strategicGoals         StrategicGoal[]

  // RELATIONS
  subscription    Subscription?
  features        FeatureAccess[]
  orders          Order[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  @@map("housing_companies")
  @@index([businessId])
}

model Apartment {
  id               String         @id @default(cuid())
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  apartmentNumber  String         
  floor            Int?
  area             Decimal?
  sharesStart      Int
  sharesEnd        Int
  shareCount       Int            
  waterFeeAdvance  Decimal        @default(0)
  elecFeeAdvance   Decimal        @default(0)
  users            User[]
  tickets          Ticket[]
  surveyResponses  SurveyResponse[]
  meters           Meter[]
  leakAlerts       LeakAlert[]
  attributes       Json?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  fees             MonthlyFee[]
  @@unique([housingCompanyId, apartmentNumber])
  @@map("apartments")
  @@index([housingCompanyId])
}

enum UserRole {
  RESIDENT
  BOARD
  MANAGER
  ADMIN
  SUPERVISOR
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  name              String?
  phone             String?
  language          String         @default("fi")
  notificationPreferences Json?
  housingCompanyId  String
  housingCompany    HousingCompany @relation(fields: [housingCompanyId], references: [id])
  apartmentId       String?
  apartment         Apartment?     @relation(fields: [apartmentId], references: [id])
  role              UserRole       @default(RESIDENT)
  password          String?        
  canApproveFinance Boolean        @default(false)
  createdTickets    Ticket[]
  initiatives       Initiative[]
  supportedInitiatives InitiativeSupport[]
  surveyResponses   SurveyResponse[]
  comments          Comment[]
  votes             Vote[]
  observations      Observation[]
  documentOrders    DocumentOrder[]
  orders            Order[]
  approvedInvoices  Invoice[]
  assignedTasks     ResidentTask[]
  bookings          Booking[]
  wallet            Wallet?
  reportedLeaks     ThermalLeak[]
  pollVotes         PollVote[]
  auditLogs         GDPRLog[]
  consentVersion    String?        // GDPR
  deletedAt         DateTime?      // Soft Delete
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  @@map("users")
  @@index([housingCompanyId])
  @@index([apartmentId])
}

enum SubscriptionPlan {
  BASIC
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
}

model Subscription {
  id               String             @id @default(cuid())
  housingCompanyId String             @unique
  housingCompany   HousingCompany     @relation(fields: [housingCompanyId], references: [id])
  plan             SubscriptionPlan   @default(BASIC)
  monthlyPrice     Float              @default(0)
  status           SubscriptionStatus @default(ACTIVE)
  expiresAt        DateTime?
  nextBillingDate  DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  @@map("subscriptions")
}

model FeatureAccess {
  id               String         @id @default(cuid())
  key              String         
  name             String
  price            Float
  isEnabled        Boolean        @default(false)
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  @@unique([housingCompanyId, key])
  @@map("feature_access")
}

enum OrderType {
  CERTIFICATE
  MODULE_UNLOCK
  SUBSCRIPTION
}

model Order {
  id               String         @id @default(cuid())
  userId           String
  user             User           @relation(fields: [userId], references: [id])
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  type             OrderType
  amount           Float
  platformRevenue  Float          @default(0)
  status           OrderStatus    @default(PENDING)
  metadata         String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("orders")
  @@index([userId])
  @@index([housingCompanyId])
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketType {
  MAINTENANCE
  RENOVATION
}

model Ticket {
  id               String         @id @default(cuid())
  title            String
  description      String
  status           TicketStatus   @default(OPEN)
  priority         TicketPriority @default(MEDIUM)
  type             TicketType     @default(MAINTENANCE)
  category         String?
  supervisor       String?
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  apartmentId      String?
  apartment        Apartment?     @relation(fields: [apartmentId], references: [id])
  createdById      String
  createdBy        User           @relation(fields: [createdById], references: [id])
  sentToMaintenanceAt DateTime?
  observationId    String?        @unique
  observation      Observation?   @relation(fields: [observationId], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("tickets")
  @@index([housingCompanyId, status])
  @@index([createdById])
}

enum RenovationStatus {
  COMPLETED
  PLANNED
}

model Renovation {
  id                String           @id @default(cuid())
  component         String
  yearDone          Int?
  plannedYear       Int?
  cost              Float
  expectedLifeSpan  Int
  description       String?
  status            RenovationStatus @default(COMPLETED)
  housingCompanyId  String
  housingCompany    HousingCompany   @relation(fields: [housingCompanyId], references: [id])
  assessments       ExpertAssessment[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  @@map("renovations")
  @@index([housingCompanyId])
}

enum ObservationStatus {
  OPEN
  REVIEWED
}

model Observation {
  id               String            @id @default(cuid())
  component        String
  description      String
  imageUrl         String?
  status           ObservationStatus @default(OPEN)
  location         String?
  userId           String
  user             User              @relation(fields: [userId], references: [id])
  housingCompanyId String
  housingCompany   HousingCompany    @relation(fields: [housingCompanyId], references: [id])
  assessment       ExpertAssessment?
  ticket           Ticket?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  @@map("observations")
  @@index([housingCompanyId])
  @@index([userId])
}

model ExpertAssessment {
  id               String           @id @default(cuid())
  observationId    String           @unique
  observation      Observation      @relation(fields: [observationId], references: [id])
  renovationId     String?
  renovation       Renovation?      @relation(fields: [renovationId], references: [id])
  severityGrade    Int
  technicalVerdict String
  recommendedYear  Int?
  options          SolutionOption[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  @@map("expert_assessments")
}

model SolutionOption {
  id                String           @id @default(cuid())
  assessmentId      String
  assessment        ExpertAssessment @relation(fields: [assessmentId], references: [id])
  title             String
  description       String
  estimatedCost     Float
  lifeSpanExtension Int
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  @@map("solution_options")
}

enum BudgetCategory {
  HEATING
  WATER
  ADMIN
  MAINTENANCE
  CLEANING
}

model BudgetLineItem {
  id               String         @id @default(cuid())
  category         BudgetCategory
  budgetedAmount   Decimal
  actualSpent      Decimal
  year             Int
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("budget_line_items")
  @@index([housingCompanyId, year])
}

enum InvoiceStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

model Invoice {
  id               String         @id @default(cuid())
  externalId       String?
  yTunnus          String?
  vendorName       String
  description      String?
  amount           Decimal
  dueDate          DateTime
  status           InvoiceStatus  @default(PENDING)
  category         BudgetCategory
  projectId        String?
  project          Project?       @relation(fields: [projectId], references: [id])
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  approvedById     String?
  approvedBy       User?          @relation(fields: [approvedById], references: [id])
  imageUrl         String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("invoices")
  @@index([housingCompanyId, status])
  @@index([projectId])
}

model VendorRule {
  id               String         @id @default(cuid())
  yTunnus          String?        
  vendorName       String?
  category         BudgetCategory
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@unique([housingCompanyId, yTunnus])
  @@map("vendor_rules")
}

enum InvestmentType {
  SOLAR
  GSHP
  LTO
  HYBRID
}

model InvestmentOption {
  id               String         @id @default(cuid())
  title            String
  type             InvestmentType
  initialCost      Decimal
  annualSavings    Decimal
  lifespan         Int
  energySavedKwh   Int
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("investment_options")
  @@index([housingCompanyId])
}

enum ProjectStatus {
  DIAGNOSIS
  ROI_ANALYSIS
  TENDERING
  TECH_LEAD
  CONSTRUCTION
  WARRANTY
  COMPLETED
}

enum ProjectType {
  WINDOWS
  ROOF
  HEATING
  PLUMBING
  FACADE
  OTHER
}

model Project {
  id               String         @id @default(cuid())
  title            String
  description      String?
  type             String
  projectType      ProjectType?
  status           ProjectStatus  @default(DIAGNOSIS)
  estimatedCost    Float?
  energySavingsEst Float?
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  tenders          Tender[]
  siteReports      SiteReport[]
  changeOrders     ChangeOrder[]
  invoices         Invoice[]
  contract         LegalContract?
  updates          BuildingUpdate[]
  scenarios        FinancialScenario[]
  loanApplications LoanApplication[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("projects")
  @@index([housingCompanyId, status])
}

enum UpdateType {
  INFO
  ALERT
  PHOTO
}

model BuildingUpdate {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  title     String
  content   String
  type      UpdateType
  createdAt DateTime @default(now())
  @@map("building_updates")
  @@index([projectId, createdAt])
}

enum PollType {
  VOTE
  FEEDBACK
}

model Poll {
  id             String       @id @default(cuid())
  title          String
  description    String
  type           PollType
  expiresAt      DateTime
  resultsVisible Boolean      @default(true)
  options        PollOption[]
  votes          PollVote[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  @@map("polls")
  @@index([expiresAt])
}

model PollOption {
  id            String     @id @default(cuid())
  pollId        String
  poll          Poll       @relation(fields: [pollId], references: [id])
  label         String
  vastikeImpact Float
  votes         PollVote[]
  @@map("poll_options")
  @@index([pollId])
}

model PollVote {
  id       String     @id @default(cuid())
  pollId   String
  poll     Poll       @relation(fields: [pollId], references: [id])
  userId   String
  user     User       @relation(fields: [userId], references: [id])
  optionId String
  option   PollOption @relation(fields: [optionId], references: [id])
  weight   Float
  createdAt DateTime  @default(now())
  @@unique([pollId, userId])
  @@map("poll_votes")
  @@index([pollId])
  @@index([userId])
}

enum TenderType {
  SUPERVISOR
  CONSTRUCTION
}

enum TenderStatus {
  OPEN
  REVIEW
  CLOSED
}

model Tender {
  id        String       @id @default(cuid())
  projectId String
  project   Project      @relation(fields: [projectId], references: [id])
  type      TenderType
  status    TenderStatus @default(OPEN)
  bids      Bid[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  @@map("tenders")
  @@index([projectId])
}

model Bid {
  id                String   @id @default(cuid())
  tenderId          String
  tender            Tender   @relation(fields: [tenderId], references: [id])
  companyName       String
  price             Float
  startDate         DateTime
  endDate           DateTime
  durationDays      Int?
  creditRating      String
  residentRating    Float?
  riskScore         Float?
  warrantyYears     Int?
  status            String   @default("RECEIVED")
  siteVisitsPerWeek Int?
  livePhotosEnabled Boolean  @default(false)
  notes             String?
  pdfUrl            String?
  isWinner          Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  @@map("bids")
  @@index([tenderId])
}

model SiteReport {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  authorId  String
  content   String
  imageUrl  String?
  timestamp DateTime @default(now())
  @@map("site_reports")
  @@index([projectId])
}

enum ChangeOrderStatus {
  PENDING
  APPROVED
  REJECTED
}

model ChangeOrder {
  id         String            @id @default(cuid())
  projectId  String
  project    Project           @relation(fields: [projectId], references: [id])
  title      String
  costImpact Float
  status     ChangeOrderStatus @default(PENDING)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  @@map("change_orders")
  @@index([projectId])
}

model MMLSyncLog {
  id               String         @id @default(cuid())
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  status           String
  recordCount      Int
  timestamp        DateTime       @default(now())
  @@map("mml_sync_logs")
}

enum DocumentType {
  CERTIFICATE
  ARTICLES
  STATEMENTS
}

enum OrderStatus {
  PENDING
  PAID
  DELIVERED
}

model DocumentOrder {
  id               String         @id @default(cuid())
  userId           String
  user             User           @relation(fields: [userId], references: [id])
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  type             DocumentType
  amount           Float
  status           OrderStatus    @default(PENDING)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("document_orders")
  @@index([userId])
}

enum GovernanceStatus {
  DRAFT
  OPEN_FOR_SUPPORT
  QUALIFIED 
  VOTING 
  APPROVED
  REJECTED
}

model Initiative {
  id               String            @id @default(cuid())
  title            String
  description      String
  status           GovernanceStatus  @default(DRAFT)
  affectedArea     String?
  housingCompanyId String
  housingCompany   HousingCompany    @relation(fields: [housingCompanyId], references: [id])
  authorId         String
  author           User              @relation(fields: [authorId], references: [id])
  supporters       InitiativeSupport[]
  votes            Vote[]
  comments         Comment[]
  meetingId        String?
  meeting          Meeting?          @relation(fields: [meetingId], references: [id])
  requiredSupport  Int               @default(10)
  votingEndsAt     DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  @@map("initiatives")
  @@index([housingCompanyId, status])
}

model InitiativeSupport {
  id           String     @id @default(cuid())
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id])
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  createdAt    DateTime   @default(now())
  @@unique([initiativeId, userId])
  @@map("initiative_supports")
}

model Comment {
  id           String     @id @default(cuid())
  text         String
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id])
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  createdAt    DateTime   @default(now())
  @@map("comments")
  @@index([initiativeId])
}

enum VoteChoice {
  YES
  NO
  ABSTAIN
}

model Vote {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id])
  choice       VoteChoice
  shares       Int        
  timestamp    DateTime   @default(now())
  @@unique([initiativeId, userId])
  @@map("votes")
  @@index([initiativeId])
}

enum MeetingType {
  GENERAL
  BOARD
}

enum SignatureStatus {
  PENDING
  SIGNED
}

model Meeting {
  id               String       @id @default(cuid())
  title            String
  type             MeetingType
  date             DateTime
  status           GovernanceStatus @default(OPEN_FOR_SUPPORT)
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  initiatives      Initiative[]
  chairmanId       String?
  secretaryId      String?
  scrutineerIds    String[] 
  minutesContent   String?
  signatureStatus  SignatureStatus @default(PENDING)
  signedUrl        String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  @@map("meetings")
  @@index([housingCompanyId, date])
}

model MeetingDocument {
  id               String       @id @default(cuid())
  title            String
  type             MeetingType
  date             DateTime
  year             Int
  url              String
  aiSummary        String?
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  @@map("meeting_documents")
  @@index([housingCompanyId, year])
}

model Survey {
  id               String         @id @default(cuid())
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  responses        SurveyResponse[]
  @@map("surveys")
  @@index([housingCompanyId])
}

model SurveyResponse {
  id        String    @id @default(cuid())
  surveyId  String
  survey    Survey    @relation(fields: [surveyId], references: [id])
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  apartmentId String?
  apartment Apartment? @relation(fields: [apartmentId], references: [id])
  createdAt DateTime  @default(now())
  @@map("survey_responses")
  @@index([surveyId])
}

enum MeterType {
  WATER_HOT
  WATER_COLD
  ELECTRICITY
}

model Meter {
  id           String    @id @default(cuid())
  apartmentId  String
  apartment    Apartment @relation(fields: [apartmentId], references: [id])
  type         MeterType
  serialNumber String
  lastReading  Decimal
  lastReadingDate DateTime
  readings     Reading[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  @@map("meters")
  @@index([apartmentId])
}

model Reading {
  id        String   @id @default(cuid())
  meterId   String
  meter     Meter    @relation(fields: [meterId], references: [id])
  value     Decimal
  date      DateTime
  isManual  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("readings")
  @@index([meterId, date])
}

model UtilityPrice {
  id             String         @id @default(cuid())
  housingCompanyId String
  housingCompany HousingCompany @relation(fields: [housingCompanyId], references: [id])
  type           MeterType
  pricePerUnit   Decimal
  validFrom      DateTime
  currency       String         @default("EUR")
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  @@map("utility_prices")
  @@index([housingCompanyId])
}

enum LeakSeverity {
  LOW
  MEDIUM
  HIGH
}

enum LeakStatus {
  ACTIVE
  RESOLVED
  IGNORED
}

enum LeakTrigger {
  SENTINEL
  GUARDIAN
  DEFENDER
}

model LeakAlert {
  id                String       @id @default(cuid())
  apartmentId       String
  apartment         Apartment    @relation(fields: [apartmentId], references: [id])
  severity          LeakSeverity
  status            LeakStatus   @default(ACTIVE)
  triggeredBy       LeakTrigger
  detectionMetadata String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  @@map("leak_alerts")
  @@index([apartmentId, status])
  @@index([createdAt])
}

enum PartnerCategory {
  PLUMBER
  ELECTRICIAN
  CLEANER
  LANDSCAPER
  LOCKSMITH
  OTHER
}

model ServicePartner {
  id               String          @id @default(cuid())
  name             String
  yTunnus          String?
  category         PartnerCategory
  rating           Float           @default(0)
  verified         Boolean         @default(false)
  housingCompanyId String
  housingCompany   HousingCompany  @relation(fields: [housingCompanyId], references: [id])
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  @@map("service_partners")
  @@index([housingCompanyId, category])
}

enum ResidentTaskStatus {
  OPEN
  IN_PROGRESS
  REVIEW
  COMPLETED
}

enum RewardType {
  HOITOVASTIKE_CREDIT
  CASH
}

model ResidentTask {
  id                 String             @id @default(cuid())
  title              String
  description        String
  housingCompanyId   String
  housingCompany     HousingCompany     @relation(fields: [housingCompanyId], references: [id])
  assignedToId       String?
  assignedTo         User?              @relation(fields: [assignedToId], references: [id])
  status             ResidentTaskStatus @default(OPEN)
  compensationAmount Float
  rewardType         RewardType         @default(HOITOVASTIKE_CREDIT)
  proofImageUrl      String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  @@map("resident_tasks")
  @@index([housingCompanyId, status])
}

enum ResourceType {
  SAUNA
  LAUNDRY
  CLUB_ROOM
  BBQ
  PARKING_GUEST
}

model Resource {
  id                String         @id @default(cuid())
  name              String
  type              ResourceType
  priceEuro         Float          @default(0)
  priceKarma        Int            @default(0)
  icon              String?
  bufferTimeMinutes Int            @default(0)
  powerRatingKw     Float          @default(0)
  housingCompanyId  String
  housingCompany    HousingCompany @relation(fields: [housingCompanyId], references: [id])
  bookings          Booking[]
  powerEvents       PowerEvent[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  @@map("resources")
  @@index([housingCompanyId])
}

enum PaymentType {
  EURO
  KARMA
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
}

model Booking {
  id          String        @id @default(cuid())
  resourceId  String
  resource    Resource      @relation(fields: [resourceId], references: [id])
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  startTime   DateTime
  endTime     DateTime
  paymentType PaymentType
  status      BookingStatus @default(CONFIRMED)
  accessCode  String?
  isPreheating Boolean      @default(false)
  powerEvents PowerEvent[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  @@map("bookings")
  @@index([resourceId, startTime])
  @@index([userId])
}

model PowerEvent {
  id            String   @id @default(cuid())
  resourceId    String
  resource      Resource @relation(fields: [resourceId], references: [id])
  bookingId     String?
  booking       Booking? @relation(fields: [bookingId], references: [id])
  timestamp     DateTime @default(now())
  eventType     String
  durationMinutes Int?
  kwhEstimated  Float?
  costEstimated Float?
  @@map("power_events")
  @@index([resourceId, timestamp])
}

model Wallet {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  euroBalance  Float    @default(0)
  karmaBalance Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  @@map("wallets")
}

model ThermalLeak {
  id               String         @id @default(cuid())
  x                Float
  y                Float
  z                Float
  severity         Float
  sector           String?
  confirmed        Boolean        @default(false)
  userId           String
  user             User           @relation(fields: [userId], references: [id])
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  createdAt        DateTime       @default(now())
  @@map("thermal_leaks")
  @@index([housingCompanyId])
}

enum ContractStatus {
  DRAFT
  SIGNING
  ACTIVE
  COMPLETED
  TERMINATED
}

model LegalContract {
  id             String         @id @default(cuid())
  projectId      String         @unique
  project        Project        @relation(fields: [projectId], references: [id])
  contractorId   String
  contractorName String
  status         ContractStatus @default(DRAFT)
  signedAt       DateTime?
  fileUrl        String?
  content        String?
  milestones     Milestone[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  @@map("legal_contracts")
}

model Milestone {
  id          String        @id @default(cuid())
  contractId  String
  contract    LegalContract @relation(fields: [contractId], references: [id])
  title       String
  amount      Float
  dueDate     DateTime
  isApproved  Boolean       @default(false)
  approvedAt  DateTime?
  approvedBy  String?
  isPaid      Boolean       @default(false)
  paidAt      DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  @@map("milestones")
  @@index([contractId])
}

model FinancialStatement {
  id               String         @id @default(cuid())
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  year             Int
  revenue          Float
  maintenanceFees  Float
  loansTotal       Float
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("financial_statements")
  @@index([housingCompanyId])
}

model Shareholder {
  id               String         @id @default(cuid())
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  name             String
  businessId       String?        
  shareCount       Int
  isInstitutional  Boolean        @default(false)
  deletedAt        DateTime?      // Soft Delete
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("shareholders")
  @@index([housingCompanyId])
}

enum LoanStatus {
  DRAFT
  ANALYSIS
  SUBMITTED
  OFFER_RECEIVED
  APPROVED
  REJECTED
  ACTIVE
}

model LoanApplication {
  id               String         @id @default(cuid())
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  projectId        String?
  project          Project?       @relation(fields: [projectId], references: [id])
  bankName         String?
  amount           Float
  purpose          String
  status           LoanStatus     @default(DRAFT)
  riskAnalysis     String?
  offerMargin      Float?
  repaymentTerm    Int?
  collateralType   String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("loan_applications")
  @@index([housingCompanyId])
  @@index([projectId])
}

model CostBenchmark {
  id                      String   @id @default(cuid())
  category                String   
  unitPriceM2             Float    
  expectedLifeYears       Int      
  technicalDepreciationRate Float  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  @@map("cost_benchmarks")
  @@unique([category])
}

model FinancialScenario {
  id                 String   @id @default(cuid())
  housingCompanyId   String
  housingCompany     HousingCompany @relation(fields: [housingCompanyId], references: [id])
  title              String
  totalLoanAmount    Float
  interestRate       Float
  termYears          Int
  monthlyImpactPerM2 Float
  projectId          String?
  project            Project?       @relation(fields: [projectId], references: [id])
  isBaseline         Boolean  @default(false)
  metadata           String?  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  @@map("financial_scenarios")
  @@index([housingCompanyId])
}

model InvestmentGrade {
  id               String         @id @default(cuid())
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  score            Float          
  grade            String         
  pillarScores     String         
  updatedAt        DateTime       @updatedAt
  createdAt        DateTime       @default(now())
  @@map("investment_grades")
  @@index([housingCompanyId])
}

model GDPRLog {
  id               String         @id @default(cuid())
  actorId          String
  actor            User           @relation(fields: [actorId], references: [id])
  action           String         // READ, WRITE, DELETE
  targetEntity     String         // e.g. "User:123"
  details          String?
  ipAddress        String?
  housingCompanyId String?
  housingCompany   HousingCompany? @relation(fields: [housingCompanyId], references: [id])
  timestamp        DateTime       @default(now())
  @@map("gdpr_logs")
  @@index([housingCompanyId])
  @@index([actorId])
}

model MonthlyFee {
  id               String         @id @default(cuid())
  housingCompanyId String
  housingCompany   HousingCompany @relation(fields: [housingCompanyId], references: [id])
  apartmentId      String
  apartment        Apartment      @relation(fields: [apartmentId], references: [id])
  referenceNumber  String
  amount           Decimal
  dueDate          DateTime
  period           DateTime       // The month being billed (e.g. 2026-02-01)
  status           InvoiceStatus  @default(PENDING)
  breakdown        Json?          // { hoitovastike: 100, rahoitus: 50, water: 20 }
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  @@map("monthly_fees")
  @@index([housingCompanyId, period])
  @@index([apartmentId])
}
// --- Temporal Engine Models ---

enum FiscalQuarter {
  Q1
  Q2
  Q3
  Q4
}

enum TaskCategory {
  GOVERNANCE    // Meetings, NLS filings, voting
  MAINTENANCE   // Inspections, snow removal, HVAC
  FINANCE       // Budgeting, tax, audit
  LEGAL         // Insurance, contracts
}

enum GoalStatus {
  IN_PROGRESS
  ACHIEVED
  DELAYED
  CRITICAL
}

model FiscalConfiguration {
  id              String         @id @default(cuid())
  companyId       String         @unique
  company         HousingCompany @relation(fields: [companyId], references: [id])
  startMonth      Int            @default(1) // 1 = January, 7 = July (Finnish: Tilikauden alkamiskuukausi)
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model AnnualTask {
  id              String         @id @default(cuid())
  companyId       String
  company         HousingCompany @relation(fields: [companyId], references: [id])
  
  title           String         // e.g., "Yhti√∂kokous" (General Meeting)
  category        TaskCategory
  quarter         FiscalQuarter
  isStatutory     Boolean        @default(false)
  description     String?
  
  // Link to 3D Space
  meshId          String?        // ID of the 3D mesh in the digital twin (e.g., "Roof_01")
  
  completedAt     DateTime?
  deadline        DateTime?
}

model StrategicGoal {
  id              String         @id @default(cuid())
  companyId       String
  company         HousingCompany @relation(fields: [companyId], references: [id])
  
  title           String         // e.g., "Energy Efficiency 2030"
  targetValue     Float?
  currentValue    Float?
  unit            String?        // e.g., "kWh/m2"
  status          GoalStatus     @default(IN_PROGRESS)
  targetDate      DateTime?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}